#!/bin/bash

function run_SatEquiv {
  (ulimit -t 259200 > .tmp; ulimit -H -t > .tmp; ulimit -m 200000000 > .tmp; ulimit -v 200000000 > .tmp; ulimit -H -v > .tmp;
  { /usr/bin/time -f "Time %E / Memory %Mk" ../../deepsec -semantics Private -distributed 35 -distant_workers grenade deepsec 23 -nb_sets $4 Protocols_SatEquiv/$3 > .deepsec_tmp$1 ;} 2> .time_tmp$1;
  time=$(< .time_tmp$1);
  query_result1=$(grep "Query" .deepsec_tmp$1);
  query_result2=$(sed '/Query/s/Query \([0-9][0-9]*\): Equivalent processes : See a summary of the input file on the HTML interface/Query \1: Equivalent/' <<< $query_result1);
  query_result3=$(sed '/Query/s/Query \([0-9][0-9]*\): Processes not equivalent : See a summary of the input file and the attack trace on the HTML interface/Query \1: Not equivalent/' <<< $query_result2);
  echo "Bench $1 / $2 / Result $query_result3 / $time" >> bench_result.txt;);
}

function run_DeepSec {
  (ulimit -t 259200 > .tmp; ulimit -H -t > .tmp; ulimit -m 200000000 > .tmp; ulimit -v 200000000 > .tmp; ulimit -H -v > .tmp;
  { /usr/bin/time -f "Time %E / Memory %Mk" ../../deepsec -semantics Private -distributed 35 -distant_workers grenade deepsec 23 -nb_sets $4 ../trace_equivalence/$3 > .deepsec_tmp$1 ;} 2> .time_tmp$1;
  time=$(< .time_tmp$1);
  query_result1=$(grep "Query" .deepsec_tmp$1);
  query_result2=$(sed '/Query/s/Query \([0-9][0-9]*\): Equivalent processes : See a summary of the input file on the HTML interface/Query \1: Equivalent/' <<< $query_result1);
  query_result3=$(sed '/Query/s/Query \([0-9][0-9]*\): Processes not equivalent : See a summary of the input file and the attack trace on the HTML interface/Query \1: Not equivalent/' <<< $query_result2);
  echo "Bench $1 / $2 / Result $query_result3 / $time" >> bench_result.txt;);
}

echo "Benchmark DeepSec" > bench_result.txt;
echo "" >> bench_result.txt;

run_SatEquiv 1 "DenningSacco 3" Denning-Sacco-A/ds-3.txt 100
run_SatEquiv 5 "Needham-Schroeder 3" Needham-Schroeder/ns-3.txt 100
run_SatEquiv 10 "Otway-Rees 3" Otway-Rees/or-tagged-3.txt 100
run_SatEquiv 12 "Toy 1" Toy/token-1.txt 100
run_SatEquiv 13 "Toy 2" Toy/token-2.txt 100
run_SatEquiv 16 "WMF 3" Wide-Mouth-Frog/wmf-without-timestamps-3.txt 100
run_SatEquiv 20 "Yahalom-lowe 3" Yahalom-lowe/yahalom-lowe-3.txt 100
run_SatEquiv 24 "Yahalom-Paulson 3" Yahalom-Paulson/yahalom-paulson-3.txt 100

run_DeepSec 26 "** WMF Std: 1s" WMF/WMF-shared-key-1session.txt 100
run_DeepSec 27 "** WMF Std: 2s" WMF/WMF-shared-key-2sessions.txt 100
run_DeepSec 28 "** WMF Std: 2s (same agent)" WMF/WMF-shared-key-2sessions-same.txt 100

run_DeepSec 29 "** WMF Basic: 1s" WMF/basic_process_version/WMF-shared-key-1session.txt 100
run_DeepSec 30 "** WMF Basic: 2s" WMF/basic_process_version/WMF-shared-key-2sessions.txt 100

run_DeepSec 32 "** Example 1" toys/example_1.txt 100
run_DeepSec 33 "** Example 2" toys/example_2.txt 100
run_DeepSec 34 "** Example 3" toys/example_3.txt 100
run_DeepSec 35 "** Simple 1 par" toys/Simple_1_par.txt 100
run_DeepSec 36 "** Simple 2 par" toys/Simple_2_par.txt 100
run_DeepSec 37 "** Simple 3 par" toys/Simple_3_par.txt 100
run_DeepSec 38 "** Simple 4 par" toys/Simple_4_par.txt 100
run_DeepSec 39 "** Simple 5 par" toys/Simple_5_par.txt 100
run_DeepSec 40 "** Simple 6 par" toys/Simple_6_par.txt 1000

run_DeepSec 42 "** PrivAuth Std: 1s" private_authentication/private_authentication_1session.txt 100
run_DeepSec 43 "** PrivAuth Std: 2s (different agents)" private_authentication/private_authentication_2sessions-diff.txt 300
run_DeepSec 44 "** PrivAuth Std: 2s (same agents)" private_authentication/private_authentication_2sessions-same.txt 300

run_DeepSec 47 "** PrivAuth Basic: 1s" private_authentication/basic_process_version/PrivateAuthentication_1session.txt 100
run_DeepSec 48 "** PrivAuth Basic: 2s (different agents)" private_authentication/basic_process_version/PrivateAuthentication_2sessions-diff.txt 300
run_DeepSec 49 "** PrivAuth Basic: 2s (same agents)" private_authentication/basic_process_version/PrivateAuthentication_2sessions-same.txt 300

run_DeepSec 52 "** Std: BAC 2s" electronic_passport/Basic_Access_Control_protocol_2sessions.txt 100

run_DeepSec 54 "** Std: PA (Anonymity) 2s" electronic_passport/Passive_Authentication_Anonymity_2sessions.txt 300

run_DeepSec 56 "** Std: PA (Unlinkability) 2s" electronic_passport/Passive_Authentication_Unlinkability_2sessions.txt 300

run_DeepSec 58 "** Basic: PA (Anonymity) 1s" electronic_passport/basic_process_version/Passive_Authentication_1_session.txt 100
run_DeepSec 59 "** Basic: PA (Anonymity) 2s" electronic_passport/basic_process_version/Passive_Authentication_2_sessions.txt 300

run_DeepSec 61 "** DenningSacco Std: 1s" denning_sacco/DenningSacco-1session.txt 100
run_DeepSec 62 "** DenningSacco Std: 2s" denning_sacco/DenningSacco-2sessions.txt 1000

run_DeepSec 64 "** DenningSacco Basic: 1s" denning_sacco/basic_access_version/DenningSacco-1session.txt 100
run_DeepSec 65 "** DenningSacco Basic: 2s" denning_sacco/basic_access_version/DenningSacco-2sessions.txt 1000

run_DeepSec 31 "** WMF Basic: 3s" WMF/basic_process_version/WMF-shared-key-3sessions.txt 3000
run_DeepSec 41 "** Simple 7 par" toys/Simple_7_par.txt 4000

run_SatEquiv 2 "DenningSacco 6" Denning-Sacco-A/ds-6.txt 4000
run_SatEquiv 7 "Needham-Schroeder 6" Needham-Schroeder/ns-6.txt 4000
run_SatEquiv 17 "WMF 6" Wide-Mouth-Frog/wmf-without-timestamps-6.txt 500

run_DeepSec 45 "** PrivAuth Std: 3s (different agents)" private_authentication/private_authentication_3sessions-diff.txt 3000
run_DeepSec 46 "** PrivAuth Std: 3s (same agents)" private_authentication/private_authentication_3sessions-same.txt 3000

run_DeepSec 50 "** PrivAuth Basic: 3s (different agents)" private_authentication/basic_process_version/PrivateAuthentication_3sessions-diff.txt 3000
run_DeepSec 51 "** PrivAuth Basic: 3s (same agents)" private_authentication/basic_process_version/PrivateAuthentication_3sessions-same.txt 3000

run_DeepSec 53 "** Std: BAC 3s" electronic_passport/Basic_Access_Control_protocol_3sessions.txt 4000

run_DeepSec 55 "** Std: PA (Anonymity) 3s" electronic_passport/Passive_Authentication_Anonymity_3sessions.txt 4000

run_DeepSec 57 "** Std: PA (Unlinkability) 3s" electronic_passport/Passive_Authentication_Unlinkability_3sessions.txt 4000

run_DeepSec 60 "** Basic: PA (Anonymity) 3s" electronic_passport/basic_process_version/Passive_Authentication_3_sessions.txt 5000

run_DeepSec 63 "** DenningSacco Std: 3s" denning_sacco/DenningSacco-3sessions.txt 5000

run_DeepSec 66 "** DenningSacco Basic: 3s" denning_sacco/basic_access_version/DenningSacco-3sessions.txt 5000

run_SatEquiv 18 "WMF 7" Wide-Mouth-Frog/wmf-without-timestamps-7.txt 1000
run_SatEquiv 21 "Yahalom-lowe 6" Yahalom-lowe/yahalom-lowe-6.txt 5000
run_SatEquiv 11 "Otway-Rees 6" Otway-Rees/or-tagged-6.txt 5000
run_SatEquiv 25 "Yahalom-Paulson 6" Yahalom-Paulson/yahalom-paulson-6.txt 6000

run_SatEquiv 14 "Toy 3" Toy/token-3.txt 5000
run_SatEquiv 3 "DenningSacco 7" Denning-Sacco-A/ds-7.txt 7000
run_SatEquiv 4 "DenningSacco 10" Denning-Sacco-A/ds-7.txt 12000
run_SatEquiv 8 "Needham-Schroeder 7" Needham-Schroeder/ns-7.txt 7000

run_SatEquiv 9 "Needham-Schroeder 10" Needham-Schroeder/ns-7.txt 12000
run_SatEquiv 15 "Toy 4" Toy/token-4.txt 10000
run_SatEquiv 19 "WMF 10" Wide-Mouth-Frog/wmf-without-timestamps-10.txt 7000
run_SatEquiv 22 "Yahalom-lowe 7" Yahalom-lowe/yahalom-lowe-7.txt 10000
run_SatEquiv 23 "Yahalom-lowe 10" Yahalom-lowe/yahalom-lowe-10.txt 15000
